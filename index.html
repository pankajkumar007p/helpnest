<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpNest - Ticketing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A simple style override to ensure the layout works well without full JS framework */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Style for success/error messages */
        .feedback-banner {
            display: none;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            border-left-width: 4px;
        }
        .feedback-banner.success {
            display: block;
            background-color: #f0fdf4; /* green-50 */
            border-color: #22c55e; /* green-500 */
            color: #15803d; /* green-700 */
        }
        .feedback-banner.error {
            display: block;
            background-color: #fef2f2;
            border-color: #fca5a5;
            color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- This div will contain the entire application -->
    <div id="app-container">
        <!-- The content will be rendered here by JavaScript -->
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const API_URL = 'http://localhost:5000'; // Your backend server URL

        // --- GLOBAL STATE ---
        let state = {
            isAuthenticated: false,
            isAdminView: false,
            activePage: 'dashboard',
            agents: [ // This can still be mock data for now
              { id: 'agent-1', name: 'Alex Green' },
              { id: 'agent-2', name: 'Brenda Blue' },
              { id: 'agent-3', name: 'Charlie Brown' },
              { id: 'agent-4', name: 'David White' },
            ],
            tickets: [], // This will be fetched from the backend
            filteredTickets: [],
            selectedTicketId: null,
            feedback: { type: '', message: '' }, // type can be 'success' or 'error'
            adminUser: { name: 'Admin User', email: 'admin@example.com' },
            isEditingProfile: false,
            ticketView: 'list',
            searchQuery: '',
            notifications: [],
            unreadNotificationCount: 0,
            cannedResponses: [
                { title: 'Password Reset', text: 'Hello,\n\nTo reset your password, please follow this link: [LINK]\n\nRegards,\nSupport Team' },
                { title: 'Billing Inquiry', text: 'Hello,\n\nThank you for contacting us about your bill. Could you please provide the invoice number so we can look into it for you?\n\nRegards,\nSupport Team' }
            ]
        };

        // --- ICONS (as functions returning SVG strings) ---
        const Icons = {
            Home: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            Ticket: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
            Book: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>`,
            Analytics: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>`,
            App: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-400"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 12v-2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4v-2a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2zm0 0v-2a4 4 0 0 1 4 4v0a4 4 0 0 1-4 4v-2a2 2 0 0 0 2-2v0a2 2 0 0 0-2-2z"/></svg>`,
            Logout: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`,
            Plus: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            Search: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            Bell: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></svg>`,
            Folder: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-indigo-500"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L8.6 3.3A2 2 0 0 0 6.9 2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16z"/></svg>`,
            Todo: () => `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>`,
        };

        // --- HTML TEMPLATE COMPONENTS ---
        
        function SidebarComponent() {
            const navItems = [
                { id: 'dashboard', icon: Icons.Home(), label: 'Dashboard' },
                { id: 'tickets', icon: Icons.Ticket(), label: 'Tickets' },
                { id: 'analytics', icon: Icons.Analytics(), label: 'Analytics' },
                { id: 'knowledgeBase', icon: Icons.Book(), label: 'Knowledge Base' },
            ];
            return `
                <aside class="w-16 md:w-64 bg-slate-800 text-white flex flex-col">
                    <div class="h-16 flex items-center justify-center md:justify-start md:px-6 border-b border-slate-700">
                        ${Icons.App()}
                        <span class="hidden md:inline ml-3 text-xl font-bold">HelpNest</span>
                    </div>
                    <nav class="flex-grow pt-4">
                        <ul>
                            ${navItems.map(item => `
                                <li>
                                    <a href="#" onclick="navigateTo('${item.id}')" class="flex items-center px-5 md:px-6 py-3 my-1 transition-colors duration-200 ${state.activePage === item.id ? 'text-white bg-indigo-600 border-l-4 border-indigo-400' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}">
                                        ${item.icon}
                                        <span class="hidden md:inline ml-4">${item.label}</span>
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </nav>
                    <div class="p-4 border-t border-slate-700">
                        <button onclick="handleLogout()" class="w-full bg-slate-700 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center md:justify-start">
                           ${Icons.Logout()}
                           <span class="hidden md:inline ml-4">Logout</span>
                        </button>
                    </div>
                </aside>
            `;
        }

        function TopBarComponent(title) {
            const adminInitial = state.adminUser.name.charAt(0).toUpperCase();
            const notificationBadge = state.unreadNotificationCount > 0 
                ? `<span id="notification-badge" class="absolute top-0 right-0 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>` 
                : '';

            const notificationList = state.notifications.length > 0 
                ? state.notifications.map(n => `<a href="#" onclick="navigateToTicket('${n.ticketId}')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${n.message}</a>`).join('')
                : `<p class="px-4 py-2 text-sm text-gray-500">No new notifications.</p>`;

            return `
                <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                    <h1 class="text-2xl font-semibold text-gray-800">${title}</h1>
                    <div class="flex items-center space-x-4">
                        <div id="new-button-wrapper" class="relative">
                            <button onclick="toggleNewDropdown()" class="hidden sm:inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                ${Icons.Plus()}
                                New
                            </button>
                            <div id="new-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                                <a href="#" onclick="alert('New Ticket clicked!')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">New Ticket</a>
                                <a href="#" onclick="alert('New Contact clicked!')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">New Contact</a>
                                <a href="#" onclick="alert('New Company clicked!')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">New Company</a>
                            </div>
                        </div>
                        <button onclick="alert('Search clicked!')" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700">${Icons.Search()}</button>
                        <div id="notification-button-wrapper" class="relative">
                            <button onclick="toggleNotificationDropdown()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 relative">
                                ${Icons.Bell()}
                                ${notificationBadge}
                            </button>
                            <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg py-1 z-20">
                                <div class="font-bold px-4 py-2 border-b">Notifications</div>
                                ${notificationList}
                            </div>
                        </div>
                        <div id="profile-button-wrapper" class="relative">
                            <button onclick="toggleProfileDropdown()" class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-700 font-bold cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">${adminInitial}</button>
                            <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                                <a href="#" onclick="event.preventDefault(); navigateTo('accountSettings')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Account Settings</a>
                                <a href="#" onclick="event.preventDefault(); navigateTo('about')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">About</a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <a href="#" onclick="event.preventDefault(); handleLogout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        function DashboardPageComponent() {
            const stats = {
                unresolved: state.tickets.filter(t => t.status !== 'Closed').length,
                open: state.tickets.filter(t => t.status === 'Open').length,
                onHold: state.tickets.filter(t => t.status === 'On hold').length,
                unassigned: state.tickets.filter(t => !t.agentId).length,
            };
            const StatCard = (title, value) => `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-gray-500 text-sm font-medium">${title}</h3>
                    <p class="text-3xl font-bold text-gray-800 mt-2">${value}</p>
                </div>
            `;
            return `
                <div id="dashboard" class="page">
                    ${TopBarComponent('Dashboard')}
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            ${StatCard('Unresolved', stats.unresolved)}
                            ${StatCard('Open', stats.open)}
                            ${StatCard('On hold', stats.onHold)}
                            ${StatCard('Unassigned', stats.unassigned)}
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="font-semibold text-lg">Unresolved tickets</h3>
                                <p class="text-sm text-gray-500">Across helpdesk</p>
                                <div class="mt-4">
                                    <div class="flex justify-between py-3 border-b"><span class="text-gray-600">Group</span><span class="text-gray-600">Open</span></div>
                                    <div class="flex justify-between py-3"><span class="font-medium text-gray-800">Unassigned</span><span class="font-medium text-gray-800">${stats.unassigned}</span></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="font-semibold text-lg">To-do</h3>
                                <div class="text-center py-10">
                                    <div class="w-16 h-16 bg-gray-100 rounded-lg mx-auto flex items-center justify-center">${Icons.Todo()}</div>
                                    <p class="mt-4 text-gray-500">You have no tasks to do!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function TicketsPageComponent() {
            const selectedTicket = state.tickets.find(t => t._id === state.selectedTicketId);
            const priorityColors = { Low: 'bg-gray-400', Medium: 'bg-yellow-400', High: 'bg-orange-500', Urgent: 'bg-red-600' };

            const TicketListItem = (ticket) => `
                <div onclick="selectTicket('${ticket._id}')" class="p-4 cursor-pointer border-b ${state.selectedTicketId === ticket._id ? 'bg-indigo-50' : 'hover:bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-gray-800 truncate pr-2">${ticket.subject}</p>
                        <span class="w-3 h-3 rounded-full flex-shrink-0 ${priorityColors[ticket.priority]}" title="${ticket.priority} priority"></span>
                    </div>
                    <p class="text-sm text-gray-600">#${ticket._id.split('-')[1]} â€¢ ${ticket.name}</p>
                    <p class="text-xs text-gray-400 mt-1">${new Date(ticket.createdAt).toLocaleString()}</p>
                </div>
            `;
            
            const TicketDetails = (ticket) => {
                if (!ticket) {
                    return `<div class="hidden md:flex items-center justify-center h-full"><p class="text-gray-500">Select a ticket to view details</p></div>`;
                }
                const agentName = state.agents.find(a => a.id === ticket.agentId)?.name || 'Unassigned';
                return `
                    <div class="p-6 h-full flex flex-col">
                        <div class="flex-shrink-0">
                            <button onclick="showTicketList()" class="md:hidden mb-4 inline-flex items-center px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                &larr; Back to list
                            </button>
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">${ticket.subject}</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-600 mb-6 pb-4 border-b">
                                <p><strong>From:</strong> ${ticket.name} &lt;${ticket.email}&gt;</p>
                                <p><strong>Ticket ID:</strong> ${ticket._id}</p>
                                <p><strong>Created:</strong> ${new Date(ticket.createdAt).toLocaleString()}</p>
                                <p><strong>Problem Type:</strong> ${ticket.problemType}</p>
                                <p><strong>Attachments:</strong> ${ticket.attachments.length > 0 ? ticket.attachments.join(', ') : 'None'}</p>
                            </div>
                        </div>
                        <div class="mb-6 flex-grow overflow-y-auto bg-white p-4 rounded-md border">
                            <p class="text-gray-800 whitespace-pre-wrap">${ticket.message}</p>
                        </div>
                        <div class="flex-shrink-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 bg-white p-4 rounded-lg border">
                            <div>
                                <label for="status" class="text-sm font-medium text-gray-700 mb-1 block">Status</label>
                                <select id="status" onchange="handleStatusChange('${ticket._id}', this.value)" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                    <option ${ticket.status === 'Open' ? 'selected' : ''}>Open</option>
                                    <option ${ticket.status === 'On hold' ? 'selected' : ''}>On hold</option>
                                    <option ${ticket.status === 'Closed' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                            <div>
                                <label for="priority" class="text-sm font-medium text-gray-700 mb-1 block">Priority</label>
                                <select id="priority" onchange="handlePriorityChange('${ticket._id}', this.value)" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                    <option ${ticket.priority === 'Low' ? 'selected' : ''}>Low</option>
                                    <option ${ticket.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option ${ticket.priority === 'High' ? 'selected' : ''}>High</option>
                                    <option ${ticket.priority === 'Urgent' ? 'selected' : ''}>Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label for="agent" class="text-sm font-medium text-gray-700 mb-1 block">Agent</label>
                                <select id="agent" onchange="handleAgentChange('${ticket._id}', this.value)" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                    <option value="">Unassigned</option>
                                    ${state.agents.map(agent => `<option value="${agent.id}" ${ticket.agentId === agent.id ? 'selected' : ''}>${agent.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-1 block">Agent Name</label>
                                <div class="w-full px-3 py-2 bg-gray-100 rounded-lg">${agentName}</div>
                            </div>
                        </div>
                        <div class="mt-4 bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold mb-2">Internal Notes</h4>
                            <div class="space-y-2 mb-4 max-h-32 overflow-y-auto">
                                ${ticket.internalNotes.length > 0 ? ticket.internalNotes.map(note => `<div class="text-sm bg-yellow-50 p-2 rounded-md"><p>${note.note}</p><p class="text-xs text-gray-500 mt-1">- ${note.author}</p></div>`).join('') : '<p class="text-sm text-gray-500">No internal notes.</p>'}
                            </div>
                            <form onsubmit="handleAddInternalNote(event, '${ticket._id}')">
                                <textarea name="internalNote" class="w-full px-3 py-2 border rounded-lg" placeholder="Add a private note..."></textarea>
                                <button type="submit" class="mt-2 px-3 py-1 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">Add Note</button>
                            </form>
                        </div>
                        <div class="mt-4 bg-white p-4 rounded-lg border">
                             <h4 class="font-semibold mb-2">Reply to Customer</h4>
                             <div class="mb-2">
                                <label for="canned-response" class="text-sm font-medium">Insert Canned Response:</label>
                                <select id="canned-response" onchange="handleInsertCannedResponse(this.value)" class="ml-2 border rounded-md p-1 text-sm">
                                    <option value="">Select a template...</option>
                                    ${state.cannedResponses.map((resp, index) => `<option value="${index}">${resp.title}</option>`).join('')}
                                </select>
                             </div>
                             <textarea id="reply-textarea" rows="5" class="w-full px-3 py-2 border rounded-lg" placeholder="Type your reply..."></textarea>
                             <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Send Reply</button>
                        </div>
                    </div>
                `;
            };

            return `
                <div id="tickets" class="page">
                    ${TopBarComponent('Tickets')}
                    <div class="flex h-[calc(100vh-65px)]">
                        <div class="w-full md:w-1/3 bg-white border-r overflow-y-auto flex-col ${state.ticketView === 'list' ? 'flex' : 'hidden md:flex'}">
                            <div class="p-4 border-b">
                                <input type="text" oninput="handleSearch(this.value)" value="${state.searchQuery}" placeholder="Search tickets..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div class="flex-grow overflow-y-auto">${state.filteredTickets.map(TicketListItem).join('')}</div>
                        </div>
                        <div class="w-full md:w-2/3 bg-gray-50 overflow-y-auto ${state.ticketView === 'details' ? 'block' : 'hidden md:block'}" id="ticket-details-panel">
                            ${TicketDetails(selectedTicket)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function AnalyticsPageComponent() {
            const totalTickets = state.tickets.length;
            const openCount = state.tickets.filter(t => t.status === 'Open').length;
            const onHoldCount = state.tickets.filter(t => t.status === 'On hold').length;
            const closedCount = state.tickets.filter(t => t.status === 'Closed').length;

            const lowPriority = state.tickets.filter(t => t.priority === 'Low').length;
            const mediumPriority = state.tickets.filter(t => t.priority === 'Medium').length;
            const highPriority = state.tickets.filter(t => t.priority === 'High').length;
            const urgentPriority = state.tickets.filter(t => t.priority === 'Urgent').length;

            const agentWorkload = state.agents.map(agent => {
                const count = state.tickets.filter(t => t.agentId === agent.id).length;
                return { name: agent.name, count };
            });

            return `
                <div id="analytics" class="page">
                    ${TopBarComponent('Analytics')}
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm border">
                                <h3 class="font-semibold text-lg">Tickets by Status</h3>
                                <div class="mt-4 space-y-2">
                                    <p><strong>Total:</strong> ${totalTickets}</p>
                                    <p class="text-green-600"><strong>Open:</strong> ${openCount}</p>
                                    <p class="text-yellow-600"><strong>On Hold:</strong> ${onHoldCount}</p>
                                    <p class="text-gray-600"><strong>Closed:</strong> ${closedCount}</p>
                                </div>
                            </div>
                             <div class="bg-white p-6 rounded-lg shadow-sm border">
                                <h3 class="font-semibold text-lg">Tickets by Priority</h3>
                                <div class="mt-4 space-y-2">
                                    <p class="text-gray-600"><strong>Low:</strong> ${lowPriority}</p>
                                    <p class="text-yellow-600"><strong>Medium:</strong> ${mediumPriority}</p>
                                    <p class="text-orange-600"><strong>High:</strong> ${highPriority}</p>
                                    <p class="text-red-600"><strong>Urgent:</strong> ${urgentPriority}</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border">
                                <h3 class="font-semibold text-lg">Agent Workload</h3>
                                <div class="mt-4 space-y-2">
                                    ${agentWorkload.map(agent => `<p><strong>${agent.name}:</strong> ${agent.count} tickets</p>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function KnowledgeBasePageComponent() {
            const categories = [{ name: 'General', articles: [{name: 'FAQ', count: 0}, {name: 'Getting Started', count: 0}, {name: 'Payments', count: 0}] }];
            return `
                <div id="knowledgeBase" class="page">
                    ${TopBarComponent('Knowledge Base')}
                    <div class="p-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <div class="flex justify-between items-center mb-6">
                                <div class="relative w-full max-w-lg">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400">${Icons.Search()}</span>
                                    <input type="text" placeholder="Search articles" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                                </div>
                                <div>
                                    <button class="px-4 py-2 border rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 mr-2">Manage</button>
                                    <button class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 flex items-center">${Icons.Plus()} New article</button>
                                </div>
                            </div>
                            <div>
                                ${categories.map(cat => `
                                    <div class="border rounded-lg p-6">
                                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">${Icons.Folder()} ${cat.name}</h3>
                                        <div class="mt-4 space-y-3 pl-9">
                                            ${cat.articles.map(article => `
                                                <div class="flex justify-between items-center">
                                                    <span class="text-indigo-600 hover:underline cursor-pointer">${article.name}</span>
                                                    <span class="text-gray-500">${article.count}</span>
                                                </div>
                                            `).join('')}
                                            <a href="#" class="text-indigo-600 hover:underline text-sm font-medium">View all ${cat.articles.length} folders</a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function AccountSettingsPageComponent() {
            const feedback = state.feedback.message ? `<div class="feedback-banner ${state.feedback.type}"><p class="font-bold">${state.feedback.type === 'success' ? 'Success!' : 'Error!'}</p><p>${state.feedback.message}</p></div>` : '';
            let content;

            if (state.isEditingProfile) {
                content = `
                    <form onsubmit="handleProfileUpdate(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="admin-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="admin-name" name="name" value="${state.adminUser.name}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="admin-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="admin-email" name="email" value="${state.adminUser.email}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                            </div>
                        </div>
                        <div class="mt-6 flex items-center space-x-4">
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Changes</button>
                            <button type="button" onclick="toggleEditProfile(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                        </div>
                    </form>
                `;
            } else {
                content = `
                    <p class="mb-2"><strong>Name:</strong> ${state.adminUser.name}</p>
                    <p class="mb-4"><strong>Email:</strong> ${state.adminUser.email}</p>
                    <button onclick="toggleEditProfile(true)" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Edit Profile</button>
                `;
            }

            return `
                <div id="accountSettings" class="page">
                    ${TopBarComponent('Account Settings')}
                    <div class="p-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <h2 class="text-2xl font-bold mb-4">Account Information</h2>
                            ${feedback}
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }

        function AboutPageComponent() {
            return `
                <div id="about" class="page">
                    ${TopBarComponent('About HelpNest')}
                    <div class="p-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border">
                            <h2 class="text-2xl font-bold mb-4">HelpNest Ticketing System</h2>
                            <p>Version 1.0.0</p>
                            <p class="mt-2">A simple and effective solution for managing customer support tickets.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function AdminLayout() {
            return `
                <div class="flex h-screen bg-gray-100">
                    ${SidebarComponent()}
                    <main class="flex-1 flex flex-col overflow-hidden">
                        ${DashboardPageComponent()}
                        ${TicketsPageComponent()}
                        ${AnalyticsPageComponent()}
                        ${KnowledgeBasePageComponent()}
                        ${AccountSettingsPageComponent()}
                        ${AboutPageComponent()}
                    </main>
                </div>
            `;
        }

        function PublicPageComponent() {
            const feedback = state.feedback.message ? `<div class="feedback-banner ${state.feedback.type}"><p class="font-bold">${state.feedback.type === 'success' ? 'Success!' : 'Error!'}</p><p>${state.feedback.message}</p></div>` : '';
            return `
                <div class="bg-gray-100 min-h-screen">
                    <header class="bg-white shadow-sm absolute top-0 left-0 right-0">
                        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                            <div class="text-2xl font-bold text-gray-800 flex items-center">
                                <span class="w-8 h-8 mr-2 text-indigo-600">${Icons.App()}</span>
                                HelpNest
                            </div>
                            <button onclick="showAdminView()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">Admin Login</button>
                        </div>
                    </header>
                    <div class="flex items-center justify-center h-screen py-16">
                        <div class="text-center">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome to HelpNest</h1>
                            <p class="text-lg text-gray-600 mb-8">Your one-stop support solution.</p>
                            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg text-left">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">Submit a Support Ticket</h2>
                                ${feedback}
                                <form id="ticket-form" onsubmit="handleTicketSubmit(event)">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                        <div><label class="block text-gray-700 text-sm font-semibold mb-2">Full Name</label><input name="name" type="text" class="w-full px-4 py-2 border rounded-lg" required /></div>
                                        <div><label class="block text-gray-700 text-sm font-semibold mb-2">Email Address</label><input name="email" type="email" class="w-full px-4 py-2 border rounded-lg" required /></div>
                                    </div>
                                    <div class="mb-4"><label class="block text-gray-700 text-sm font-semibold mb-2">Subject</label><input name="subject" type="text" class="w-full px-4 py-2 border rounded-lg" required /></div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Type of Problem</label>
                                            <select name="problemType" class="w-full px-4 py-2 border rounded-lg bg-white" required><option value="" disabled selected>Select a category...</option><option>Technical Support</option><option>Billing Inquiry</option><option>Feature Request</option><option>General Question</option></select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">Priority</label>
                                            <select name="priority" class="w-full px-4 py-2 border rounded-lg bg-white" required><option>Low</option><option>Medium</option><option>High</option><option>Urgent</option></select>
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">Attachments</label>
                                        <input type="file" name="attachment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                                    </div>
                                    <div class="mb-6"><label class="block text-gray-700 text-sm font-semibold mb-2">Message</label><textarea name="message" rows="5" class="w-full px-4 py-2 border rounded-lg" required></textarea></div>
                                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700">Submit Ticket</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function LoginPageComponent() {
            return `
                <div class="min-h-screen bg-slate-800 flex flex-col justify-center items-center p-4">
                    <div class="text-center mb-8">
                        <span class="text-indigo-400">${Icons.App()}</span>
                        <h1 class="text-4xl font-bold text-white mt-4">HelpNest</h1>
                    </div>
                    <div class="max-w-sm w-full bg-white p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Admin Login</h2>
                        <form onsubmit="event.preventDefault(); handleLogin();">
                            <div class="mb-6"><label class="block text-gray-700 font-semibold mb-2">Username</label><input type="text" id="username" value="Admin" class="w-full px-4 py-2 border rounded-lg" required /></div>
                            <div class="mb-6"><label class="block text-gray-700 font-semibold mb-2">Password</label><input type="password" id="password" value="Admin@123" class="w-full px-4 py-2 border rounded-lg" required /></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700">Login</button>
                        </form>
                    </div>
                    <button onclick="showPublicView()" class="mt-6 text-indigo-300 hover:text-white">Back to public ticket submission</button>
                </div>
            `;
        }

        // --- RENDER & EVENT HANDLER LOGIC ---
        const appContainer = document.getElementById('app-container');

        function render() {
            // Before rendering, clear any old feedback messages
            if (state.isAdminView && state.isAuthenticated && state.activePage !== 'accountSettings') {
                 state.feedback = { type: '', message: '' };
            }

            if (!state.isAdminView) {
                appContainer.innerHTML = PublicPageComponent();
            } else {
                if (!state.isAuthenticated) {
                    appContainer.innerHTML = LoginPageComponent();
                } else {
                    appContainer.innerHTML = AdminLayout();
                    // Make the current page visible
                    const allPages = document.querySelectorAll('.page');
                    allPages.forEach(p => p.classList.remove('active'));
                    document.getElementById(state.activePage)?.classList.add('active');
                }
            }
        }

        // Event Handlers
        function navigateTo(pageId) {
            state.activePage = pageId;
            state.isEditingProfile = false; // Reset editing mode when navigating away
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileDropdown) {
                profileDropdown.classList.add('hidden');
            }
            const newDropdown = document.getElementById('new-dropdown');
            if (newDropdown) {
                newDropdown.classList.add('hidden');
            }
            render();
        }

        function navigateToTicket(ticketId) {
            state.selectedTicketId = ticketId;
            navigateTo('tickets');
        }
        
        function selectTicket(ticketId) {
            state.selectedTicketId = ticketId;
            state.ticketView = 'details'; // On mobile, this will show the details pane
            render();
        }

        function showTicketList() {
            state.ticketView = 'list';
            render();
        }

        function handleLogin() {
            // Mock login logic
            const username = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (username === 'Admin' && pass === 'Admin@123') {
                state.isAuthenticated = true;
                state.isAdminView = true;
                state.filteredTickets = [...state.tickets]; // Reset filter on login
                render();
            } else {
                alert('Invalid credentials!');
            }
        }
        
        function handleTicketSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const attachment = formData.get('attachment');
            const newTicket = {
                _id: `TICKET-${Date.now()}`,
                name: formData.get('name'),
                email: formData.get('email'),
                subject: formData.get('subject'),
                message: formData.get('message'),
                problemType: formData.get('problemType'),
                priority: formData.get('priority'),
                status: 'Open',
                agentId: null,
                createdAt: new Date().toISOString(),
                internalNotes: [],
                attachments: attachment && attachment.name ? [attachment.name] : []
            };
            // Add the new ticket to the start of the main tickets array
            state.tickets.unshift(newTicket);
            state.filteredTickets.unshift(newTicket);
            
            // Create a notification
            const notification = {
                id: Date.now(),
                message: `New ticket from ${newTicket.name}`,
                ticketId: newTicket._id
            };
            state.notifications.unshift(notification);
            state.unreadNotificationCount++;

            // Set feedback message
            state.feedback = { type: 'success', message: `Your ticket (${newTicket._id}) has been submitted successfully!` };
            
            // Reset the form and re-render the public page to show the message
            form.reset();
            render();
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.isAdminView = false;
            render();
        }

        function showAdminView() {
            state.isAdminView = true;
            render();
        }

        function showPublicView() {
            state.isAdminView = false;
            render();
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }

        function toggleNewDropdown() {
            const dropdown = document.getElementById('new-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }

        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    // Mark notifications as read when dropdown is opened
                    state.unreadNotificationCount = 0;
                    render();
                }
            }
        }

        function toggleEditProfile(isEditing) {
            state.isEditingProfile = isEditing;
            render();
        }

        function handleProfileUpdate(event) {
            event.preventDefault();
            const newName = document.getElementById('admin-name').value;
            const newEmail = document.getElementById('admin-email').value;
            
            state.adminUser.name = newName;
            state.adminUser.email = newEmail;
            
            state.isEditingProfile = false;
            state.feedback = { type: 'success', message: 'Profile updated successfully!' };
            render();
        }

        function handleSearch(query) {
            state.searchQuery = query;
            const lowerCaseQuery = query.toLowerCase();
            state.filteredTickets = state.tickets.filter(ticket => 
                ticket.subject.toLowerCase().includes(lowerCaseQuery) ||
                ticket.name.toLowerCase().includes(lowerCaseQuery) ||
                ticket.email.toLowerCase().includes(lowerCaseQuery)
            );
            render();
        }

        function handleStatusChange(ticketId, newStatus) {
            const ticket = state.tickets.find(t => t._id === ticketId);
            if (ticket) {
                ticket.status = newStatus;
                render();
            }
        }

        function handleAgentChange(ticketId, newAgentId) {
            const ticket = state.tickets.find(t => t._id === ticketId);
            if (ticket) {
                ticket.agentId = newAgentId || null;
                render();
            }
        }

        function handlePriorityChange(ticketId, newPriority) {
            const ticket = state.tickets.find(t => t._id === ticketId);
            if (ticket) {
                ticket.priority = newPriority;
                render();
            }
        }

        function handleAddInternalNote(event, ticketId) {
            event.preventDefault();
            const form = event.target;
            const noteText = form.internalNote.value;
            if (!noteText) return;

            const ticket = state.tickets.find(t => t._id === ticketId);
            if (ticket) {
                ticket.internalNotes.push({ author: state.adminUser.name, note: noteText });
                form.reset();
                render();
            }
        }

        function handleInsertCannedResponse(index) {
            if (index === "") return;
            const response = state.cannedResponses[index];
            const textarea = document.getElementById('reply-textarea');
            if (textarea) {
                textarea.value = response.text;
            }
        }

        // Close dropdowns if clicked outside
        window.addEventListener('click', function(e) {
            const profileWrapper = document.getElementById('profile-button-wrapper');
            const profileDropdown = document.getElementById('profile-dropdown');
            if (profileDropdown && !profileWrapper?.contains(e.target)) {
                profileDropdown.classList.add('hidden');
            }

            const newWrapper = document.getElementById('new-button-wrapper');
            const newDropdown = document.getElementById('new-dropdown');
            if (newDropdown && !newWrapper?.contains(e.target)) {
                newDropdown.classList.add('hidden');
            }

            const notificationWrapper = document.getElementById('notification-button-wrapper');
            const notificationDropdown = document.getElementById('notification-dropdown');
            if (notificationDropdown && !notificationWrapper?.contains(e.target)) {
                notificationDropdown.classList.add('hidden');
            }
        });
        
        // Initial Render
        render();

    </script>

</body>
</html>
